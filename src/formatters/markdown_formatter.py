"""Markdown formatter for daily reports."""

from datetime import datetime
from typing import Dict, List, Optional
from collections import defaultdict
from src.models.analysis import AnalysisResult, CategoryType
from src.models.report import DailyReport
from src.models.deep_analysis import DeepAnalysis


class MarkdownFormatter:
    """Formats analysis results into markdown reports."""

    # Category emojis
    CATEGORY_EMOJIS = {
        "Breaking News": "ðŸ”¥",
        "Research": "ðŸ”¬",
        "Tools/Products": "ðŸ› ï¸",
        "Business": "ðŸ’¼",
        "Tutorial": "ðŸ“š",
    }

    CATEGORY_NAMES_CN = {
        "Breaking News": "é‡å¤§æ–°èž",
        "Research": "å­¸è¡“ç ”ç©¶",
        "Tools/Products": "å·¥å…·èˆ‡ç”¢å“",
        "Business": "å•†æ¥­å‹•æ…‹",
        "Tutorial": "æŠ€è¡“æ•™ç¨‹",
    }

    # æ”¹è¿›çš„Telegramæ¶ˆæ¯æ¨¡æ¿ - æ›´æ¸…æ™°æ˜“è¯»
    TELEGRAM_TEMPLATE = """ðŸ¤– *AIå¿«è¨Š*
ðŸ“… {{ push_time }}
{{ divider }}
ðŸ“Š *æœ¬æœŸæ‘˜è¦* Â· å…± *{{ total_articles }}* å‰‡

{% set ns = namespace(num=1) %}
{% for category, articles in articles_by_category.items() %}
{% if articles %}
{{ divider }}
*{{ category_emoji[category] }} {{ category_names[category] }}* ({{ articles|length }}å‰‡)
{{ divider }}

{% for analysis in articles %}
{% set deep = deep_analyses_map.get(analysis.article.url) %}
*{{ ns.num }}. {{ escape(analysis.title_cn) }}* {{ importance_stars(analysis.importance_score) }}
_ä¾†æº: {{ escape(analysis.article.source) }}_

ðŸ’­ {{ escape(analysis.summary) }}
ðŸ’¡ _{{ escape(analysis.insight) }}_
{% if deep %}

ðŸ” *æ·±åº¦åˆ†æž*
{% if deep.technical_context.background %}
  ðŸ“– *æŠ€è¡“èƒŒæ™¯*: {{ escape(deep.technical_context.background) }}
{% endif %}
{% if deep.technical_context.key_technologies %}
  ðŸ”§ *é—œéµæŠ€è¡“*: {{ deep.technical_context.key_technologies|join(', ') }}
{% endif %}
{% if deep.key_insights %}
  ðŸŽ¯ *æ ¸å¿ƒæ´žå¯Ÿ*:
{% for insight in deep.key_insights %}
    â€¢ {{ escape(insight) }}
{% endfor %}
{% endif %}
{% if deep.impact %}
  ðŸ“Š *å½±éŸ¿åˆ†æž* ({{ deep.impact.impact_level }}/5):
    â†’ ç›´æŽ¥å½±éŸ¿: {{ escape(deep.impact.immediate_impact) }}
    â†’ é•·æœŸå½±éŸ¿: {{ escape(deep.impact.long_term_impact) }}
{% if deep.impact.affected_sectors %}
    â†’ å—å½±éŸ¿é ˜åŸŸ: {{ deep.impact.affected_sectors|join(', ') }}
{% endif %}
{% endif %}
{% if deep.guidance and deep.guidance.action_items %}
  ðŸ’¼ *å¯¦è¸å»ºè­°*:
{% for action in deep.guidance.action_items %}
    âœ… {{ escape(action) }}
{% endfor %}
{% endif %}
{% if deep.controversies %}
  âš ï¸ *çˆ­è­°é»ž*:
{% for controversy in deep.controversies %}
    â€¢ {{ escape(controversy) }}
{% endfor %}
{% endif %}
{% endif %}
ðŸ”— [é–±è®€åŽŸæ–‡]({{ analysis.article.url }})

{% set ns.num = ns.num + 1 %}
{% endfor %}
{% endif %}
{% endfor %}
{{ divider }}
_ðŸ¤– Auto-generated by AI News Brief_
"""

    @staticmethod
    def escape_markdown(text: str) -> str:
        """Escape special characters for Telegram Markdown (V1) format.

        Args:
            text: Text to escape

        Returns:
            Escaped text safe for Telegram Markdown
        """
        if not text:
            return ""
        # Characters that need to be escaped in Telegram Markdown (V1)
        # We only really need to escape _, *, [ and ` for V1
        special_chars = ['_', '*', '`']
        for char in special_chars:
            text = text.replace(char, f'\\{char}')
        return text

    def __init__(self):
        """Initialize markdown formatter."""
        from jinja2 import Template
        self.telegram_template = Template(self.TELEGRAM_TEMPLATE)


    @staticmethod
    def _importance_stars(score: int) -> str:
        """Convert importance score to star rating.

        Args:
            score: Importance score (0-10)

        Returns:
            Star rating string (e.g., "â­â­â­")
        """
        if score >= 9:
            star_count = 5
        elif score >= 7:
            star_count = 4
        elif score >= 5:
            star_count = 3
        elif score >= 3:
            star_count = 2
        else:
            star_count = 1
        return "â­" * star_count

    @staticmethod
    def _importance_icon(score: int) -> str:
        """Convert importance score to color icon.

        Args:
            score: Importance score (0-10)

        Returns:
            Color icon indicating importance level
        """
        if score >= 8:
            return "ðŸ”´"  # High importance
        elif score >= 6:
            return "ðŸŸ¡"  # Medium importance
        else:
            return "ðŸŸ¢"  # Normal importance

    def format(
        self,
        date: datetime,
        analyzed_articles: List[AnalysisResult],
        deep_analyses: Optional[List[DeepAnalysis]] = None
    ) -> DailyReport:
        """Format analyzed articles into a daily report.

        Args:
            date: Report date
            analyzed_articles: List of analyzed articles
            deep_analyses: Optional list of deep analyses for high-value articles

        Returns:
            DailyReport object
        """
        # Group articles by category and sort by importance
        articles_by_category = self._group_by_category(analyzed_articles)

        # Create deep analyses map for quick lookup
        deep_analyses_map = {}
        if deep_analyses:
            deep_analyses_map = {deep.article_url: deep for deep in deep_analyses}

        # Calculate statistics
        total_articles = len(analyzed_articles)
        average_importance = (
            sum(a.importance_score for a in analyzed_articles) / total_articles
            if total_articles > 0
            else 0
        )

        # Generate markdown (Telegram format)
        push_time = datetime.now().strftime("%Y-%m-%d %H:%M")
        markdown_content = self.telegram_template.render(
            date=date.strftime("%Y-%m-%d"),
            push_time=push_time,
            total_articles=total_articles,
            average_importance=f"{average_importance:.1f}",
            articles_by_category=articles_by_category,
            deep_analyses_map=deep_analyses_map,
            category_emoji=self.CATEGORY_EMOJIS,
            category_names=self.CATEGORY_NAMES_CN,
            divider="â”€" * 30,
            importance_stars=self._importance_stars,
            importance_icon=self._importance_icon,
            escape=self.escape_markdown,
            generation_time=datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        )

        return DailyReport(
            date=date,
            articles_by_category=articles_by_category,
            markdown_content=markdown_content,
            total_articles=total_articles,
            average_importance=average_importance,
        )

    def _group_by_category(
        self, articles: List[AnalysisResult]
    ) -> Dict[CategoryType, List[AnalysisResult]]:
        """Group articles by category and sort by importance.

        Args:
            articles: List of analyzed articles

        Returns:
            Dict mapping category to sorted list of articles
        """
        grouped: Dict[CategoryType, List[AnalysisResult]] = defaultdict(list)

        for article in articles:
            grouped[article.category].append(article)

        # Sort each category by importance score (descending)
        for category in grouped:
            grouped[category].sort(key=lambda x: x.importance_score, reverse=True)

        # Return in desired order
        ordered_categories = ["Breaking News", "Research", "Tools/Products", "Business", "Tutorial"]
        return {cat: grouped[cat] for cat in ordered_categories if cat in grouped}

    def _format_relative_time(self, dt: datetime) -> str:
        """Format datetime as relative time string.

        Args:
            dt: Datetime to format

        Returns:
            Relative time string (e.g., "2å°æ™‚å‰")
        """
        now = datetime.now()
        if dt.tzinfo is not None:
            dt = dt.replace(tzinfo=None)

        delta = now - dt
        days = delta.days
        hours = delta.seconds // 3600
        minutes = delta.seconds // 60

        if days > 0:
            return f"{days}å¤©å‰"
        if hours > 0:
            return f"{hours}å°æ™‚å‰"
        if minutes > 0:
            return f"{minutes}åˆ†é˜å‰"
        return "å‰›å‰›"

    def format_telegram_message(self, data: DailyReport) -> str:
        """Format complete Telegram message.

        Args:
            data: Daily report data

        Returns:
            Formatted Telegram message
        """
        return data.markdown_content

    def format_markdown_report(self, data: DailyReport) -> str:
        """Format complete Markdown report.

        Args:
            data: Daily report data

        Returns:
            Formatted Markdown report
        """
        return data.markdown_content
